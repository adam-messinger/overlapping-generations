<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Overlapping Generations Model</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #111827;
      color: #fff;
      min-height: 100vh;
      padding: 12px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
    h1 { color: #F59E0B; font-size: 1.25rem; }
    .subtitle { color: #6B7280; font-size: 0.75rem; }
    .reset-btn {
      padding: 4px 8px;
      background: #374151;
      border: none;
      border-radius: 4px;
      color: #D1D5DB;
      cursor: pointer;
      font-size: 0.75rem;
    }
    .reset-btn:hover { background: #4B5563; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    @media (max-width: 900px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
    .stat-card {
      background: rgba(31, 41, 55, 0.5);
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 10px;
    }
    .stat-card.warn { border-color: rgba(239, 68, 68, 0.5); }
    .stat-header { display: flex; align-items: center; gap: 4px; margin-bottom: 2px; }
    .stat-icon { font-size: 0.875rem; }
    .stat-label { color: #9CA3AF; font-size: 0.75rem; }
    .stat-value { font-size: 1.125rem; font-weight: bold; color: #F59E0B; }
    .stat-card.warn .stat-value { color: #F87171; }
    .stat-sub { color: #6B7280; font-size: 0.75rem; }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 12px;
    }
    @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

    .controls-panel {
      background: rgba(31, 41, 55, 0.5);
      border: 1px solid #374151;
      border-radius: 12px;
      padding: 12px;
      max-height: 560px;
      overflow-y: auto;
    }
    .tab-buttons { display: flex; gap: 4px; margin-bottom: 8px; flex-wrap: wrap; }
    .tab-btn {
      padding: 4px 8px;
      background: #374151;
      border: none;
      border-radius: 4px;
      color: #D1D5DB;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .tab-btn.active { background: #F59E0B; color: #111827; }

    .section-title { color: #F59E0B; font-size: 0.75rem; font-weight: 500; margin: 12px 0 6px; }
    .section-title:first-child { margin-top: 0; }

    .slider-group { margin-bottom: 10px; }
    .slider-header { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 2px; }
    .slider-label { color: #9CA3AF; }
    .slider-value { color: #F59E0B; font-family: monospace; }
    input[type="range"] {
      width: 100%;
      height: 6px;
      background: #374151;
      border-radius: 3px;
      appearance: none;
      cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 14px;
      height: 14px;
      background: #F59E0B;
      border-radius: 50%;
    }
    .slider-hint { color: #4B5563; font-size: 0.7rem; margin-top: 2px; }

    .charts-panel {
      background: rgba(31, 41, 55, 0.5);
      border: 1px solid #374151;
      border-radius: 12px;
      padding: 12px;
    }
    .chart-container { height: 280px; position: relative; }
    .chart-footer {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-top: 8px;
    }
    .footer-stat {
      background: rgba(55, 65, 81, 0.5);
      border-radius: 4px;
      padding: 6px;
      font-size: 0.75rem;
    }
    .footer-stat span:first-child { color: #6B7280; }
    .footer-stat .val { font-family: monospace; }
    .footer-stat .val.amber { color: #F59E0B; }
    .footer-stat .val.blue { color: #60A5FA; }
    .footer-stat .val.emerald { color: #34D399; }
    .footer-stat .val.red { color: #F87171; }

    .info-bar {
      margin-top: 8px;
      padding: 8px;
      background: rgba(31, 41, 55, 0.3);
      border: 1px solid rgba(55, 65, 81, 0.5);
      border-radius: 8px;
      font-size: 0.7rem;
      color: #9CA3AF;
    }
    .info-bar .eq {
      font-family: 'Times New Roman', serif;
      font-style: italic;
      color: #D1D5DB;
    }
    .equations {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      text-align: center;
    }
    @media (max-width: 700px) { .equations { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Overlapping Generations Model</h1>
        <p class="subtitle">Diamond (1965) OLG with production, market-clearing, and fiscal policy</p>
      </div>
      <button class="reset-btn" onclick="resetToDefaults()">Reset</button>
    </header>

    <div class="stats-grid" id="stats-grid"></div>

    <div class="main-grid">
      <div class="controls-panel">
        <div class="tab-buttons" id="param-tabs"></div>
        <div id="param-content"></div>
      </div>

      <div class="charts-panel">
        <div class="tab-buttons" id="chart-tabs"></div>
        <div class="chart-container">
          <canvas id="mainChart"></canvas>
        </div>
        <div class="chart-footer" id="chart-footer"></div>
      </div>
    </div>

    <div class="info-bar">
      <div class="equations">
        <div><span class="eq">Y = A¬∑K<sup>Œ±</sup>¬∑L<sup>1-Œ±</sup></span><br>Production</div>
        <div><span class="eq">w = (1-Œ±)¬∑Y/L, r = Œ±¬∑Y/K - Œ¥</span><br>Factor Prices</div>
        <div><span class="eq">u'(c<sub>y</sub>) = Œ≤(1+r)¬∑u'(c<sub>o</sub>)</span><br>Euler Equation</div>
      </div>
    </div>
  </div>

<script>
// ============================================
// OVERLAPPING GENERATIONS MODEL
// Diamond (1965) with government sector
// ============================================

// Model: 3-period life cycle (Young, Middle, Old)
// Young (20-40):  Work at lower productivity, save aggressively
// Middle (40-60): Work at peak productivity, save moderately
// Old (60-80):    Retired, consume savings + Social Security

const DEFAULT_PARAMS = {
  // Production
  alpha: 0.33,              // Capital share (Cobb-Douglas)
  tfp: 1.0,                 // Total factor productivity
  delta: 0.05,              // Depreciation rate

  // Preferences
  beta: 0.96,               // Discount factor (annual)
  gamma: 2.0,               // Risk aversion (CRRA)

  // Demographics (annual rates)
  birthRate: 0.012,         // Population growth
  agingRate: 0.05,          // 1/20 years per stage
  deathRate: 0.05,          // Mortality in old age

  // Initial conditions (normalized)
  initialCapital: 3.0,      // K/L ratio
  initialPopYoung: 1.0,     // Normalized
  initialPopMiddle: 0.9,
  initialPopOld: 0.6,

  // Government
  taxRate: 0.20,            // Labor income tax
  govSpendingRate: 0.15,    // G/Y ratio
  ssReplacementRate: 0.35,  // Social Security replacement
  initialDebtRatio: 1.20,   // Debt/GDP

  // Simulation
  yearsToSimulate: 50,

  // Shocks (for scenarios)
  tfpGrowth: 0.01,          // Annual TFP growth
  agingShock: 0.0,          // Extra aging (demographic transition)
};

// ============================================
// STATE
// ============================================
let params = { ...DEFAULT_PARAMS };
let activeParamTab = 'production';
let activeChartTab = 'capital';
let simulationData = [];
let chart = null;

// ============================================
// OLG SIMULATION ENGINE
// ============================================
function runSimulation() {
  const history = [];

  // State variables
  let K = params.initialCapital;  // Capital stock
  let popYoung = params.initialPopYoung;
  let popMiddle = params.initialPopMiddle;
  let popOld = params.initialPopOld;
  let debt = params.initialDebtRatio * params.initialCapital;  // Government debt
  let tfp = params.tfp;

  // Wealth by cohort (assets held)
  let wealthYoung = 0.5;
  let wealthMiddle = 2.0;
  let wealthOld = 3.0;

  for (let t = 0; t < params.yearsToSimulate; t++) {
    const year = 2026 + t;

    // === DEMOGRAPHICS ===
    const effectiveAgingRate = params.agingRate + params.agingShock;
    const newMiddle = popYoung * effectiveAgingRate;
    const newOld = popMiddle * effectiveAgingRate;
    const deaths = popOld * params.deathRate;
    const births = (popYoung + popMiddle) * params.birthRate;

    // === LABOR SUPPLY ===
    // Young work at 70% productivity, Middle at 100%
    const laborYoung = popYoung * 0.7;
    const laborMiddle = popMiddle * 1.0;
    const L = laborYoung + laborMiddle;

    // === PRODUCTION (Cobb-Douglas) ===
    // Y = A * K^Œ± * L^(1-Œ±)
    const Y = tfp * Math.pow(K, params.alpha) * Math.pow(L, 1 - params.alpha);
    const yPerCapita = Y / (popYoung + popMiddle + popOld);

    // === FACTOR PRICES (Competitive Markets) ===
    // Firms maximize profit: max A*K^Œ±*L^(1-Œ±) - wL - rK
    // FOC: w = (1-Œ±)*Y/L, r = Œ±*Y/K
    const wage = (1 - params.alpha) * Y / L;
    const r_gross = params.alpha * Y / K;
    const r = r_gross - params.delta;  // Net return = MPK - depreciation

    // === GOVERNMENT ===
    const taxRevenue = params.taxRate * wage * L;
    const govSpending = params.govSpendingRate * Y;
    const ssPayments = params.ssReplacementRate * wage * popOld;
    const interestPayment = r * debt;
    const deficit = govSpending + ssPayments + interestPayment - taxRevenue;
    debt += deficit;
    const debtToGdp = debt / Y;

    // === HOUSEHOLD OPTIMIZATION (CRRA Utility) ===
    // Households maximize: Œ£ Œ≤^t * c^(1-Œ≥)/(1-Œ≥)
    // Euler equation: c_{t+1}/c_t = (Œ≤(1+r))^(1/Œ≥)

    // After-tax wage
    const wageAfterTax = wage * (1 - params.taxRate);

    // Optimal savings rate from Euler equation
    // For CRRA utility with Œ≤ and Œ≥:
    // In steady state: s = Œ≤^(1/Œ≥) * (1+r)^((1-Œ≥)/Œ≥) / (1 + Œ≤^(1/Œ≥) * (1+r)^((1-Œ≥)/Œ≥))
    const betaAdj = Math.pow(params.beta, 1/params.gamma);
    const rAdj = Math.pow(1 + r, (1 - params.gamma) / params.gamma);
    const savingsRateOptimal = (betaAdj * rAdj) / (1 + betaAdj * rAdj);

    // Cohort-specific behavior
    // Young: save more (longer horizon)
    // Middle: save moderately
    const savingsRateYoung = Math.min(0.5, savingsRateOptimal * 1.3);
    const savingsRateMiddle = savingsRateOptimal * 0.9;

    // === CONSUMPTION BY COHORT ===
    const incomeYoung = wageAfterTax * 0.7 * popYoung;
    const incomeMiddle = wageAfterTax * 1.0 * popMiddle;
    const incomeOld = ssPayments + (1 + r) * wealthOld * 0.1;  // SS + drawdown

    const consumptionYoung = incomeYoung * (1 - savingsRateYoung);
    const consumptionMiddle = incomeMiddle * (1 - savingsRateMiddle);
    const consumptionOld = incomeOld;  // Old consume everything

    const totalConsumption = consumptionYoung + consumptionMiddle + consumptionOld;

    // === SAVINGS & CAPITAL ACCUMULATION ===
    const savingsYoung = incomeYoung * savingsRateYoung;
    const savingsMiddle = incomeMiddle * savingsRateMiddle;
    const savingsOld = -wealthOld * params.deathRate;  // Dissaving (death)

    const totalSavings = savingsYoung + savingsMiddle;
    const investment = totalSavings - deficit;  // Govt borrowing crowds out

    // Capital accumulation: K_{t+1} = (1-Œ¥)K + I
    const K_next = (1 - params.delta) * K + Math.max(0, investment);

    // === WEALTH DYNAMICS ===
    // Wealth = accumulated savings earning return r
    const wealthYoungNew = wealthYoung * (1 + r) + savingsYoung;
    const wealthMiddleNew = wealthMiddle * (1 + r) + savingsMiddle;
    const wealthOldNew = wealthOld * (1 + r) * (1 - params.deathRate * 0.5);  // Drawdown

    // Wealth transfers: dying old ‚Üí young/middle
    const bequests = wealthOld * params.deathRate;

    // === DYNAMIC EFFICIENCY CHECK ===
    // Economy is dynamically efficient if r > n (interest > pop growth)
    const popGrowth = births / (popYoung + popMiddle + popOld);
    const dynamicallyEfficient = r > popGrowth;

    // === STEADY STATE CAPITAL ===
    // In Diamond model: k* = (Œ±A/(r*+Œ¥))^(1/(1-Œ±))
    // Golden rule: r = n (max consumption)
    const kSteadyState = Math.pow((params.alpha * tfp) / (r + params.delta), 1 / (1 - params.alpha));

    // === UPDATE STATE ===
    // Demographics
    popYoung = popYoung * (1 - effectiveAgingRate) + births;
    popMiddle = popMiddle * (1 - effectiveAgingRate) + newMiddle;
    popOld = popOld * (1 - params.deathRate) + newOld;

    // Capital
    K = K_next;

    // Wealth (with bequests distributed)
    wealthYoung = wealthYoungNew + bequests * 0.3;
    wealthMiddle = wealthMiddleNew + bequests * 0.7;
    wealthOld = Math.max(0, wealthOldNew);

    // TFP growth
    tfp *= (1 + params.tfpGrowth);

    // Record
    history.push({
      year,
      // Production
      output: Y,
      capital: K,
      labor: L,
      tfp,
      yPerCapita,

      // Prices
      wage,
      interestRate: r,
      r_gross,

      // Demographics
      popYoung,
      popMiddle,
      popOld,
      popTotal: popYoung + popMiddle + popOld,
      dependencyRatio: popOld / (popYoung + popMiddle),

      // Consumption & Savings
      consumption: totalConsumption,
      consPerCapita: totalConsumption / (popYoung + popMiddle + popOld),
      savingsRate: totalSavings / Y,
      investment,

      // Wealth
      wealthYoung,
      wealthMiddle,
      wealthOld,
      totalWealth: wealthYoung + wealthMiddle + wealthOld,

      // Government
      taxRevenue,
      govSpending,
      ssPayments,
      deficit,
      debt,
      debtToGdp,

      // Efficiency
      dynamicallyEfficient,
      kSteadyState,
      capitalGap: (K - kSteadyState) / kSteadyState,
    });
  }

  return history;
}

// ============================================
// UI RENDERING
// ============================================
function renderStats() {
  const start = simulationData[0];
  const end = simulationData[simulationData.length - 1];

  const stats = [
    {
      icon: 'üè≠',
      label: 'Output/Cap',
      value: end.yPerCapita.toFixed(2),
      sub: `from ${start.yPerCapita.toFixed(2)}`,
      warn: end.yPerCapita < start.yPerCapita
    },
    {
      icon: 'üí∞',
      label: 'Interest Rate',
      value: `${(end.interestRate * 100).toFixed(1)}%`,
      sub: `MPK: ${(end.r_gross * 100).toFixed(1)}%`,
      warn: end.interestRate < 0
    },
    {
      icon: 'üë∑',
      label: 'Wage',
      value: end.wage.toFixed(2),
      sub: `from ${start.wage.toFixed(2)}`,
      warn: false
    },
    {
      icon: 'üìä',
      label: 'K/L Ratio',
      value: (end.capital / end.labor).toFixed(2),
      sub: `k*: ${end.kSteadyState.toFixed(2)}`,
      warn: Math.abs(end.capitalGap) > 0.2
    },
    {
      icon: 'üë¥',
      label: 'Dependency',
      value: `${(end.dependencyRatio * 100).toFixed(0)}%`,
      sub: `from ${(start.dependencyRatio * 100).toFixed(0)}%`,
      warn: end.dependencyRatio > 0.5
    },
    {
      icon: end.dynamicallyEfficient ? '‚úì' : '‚ö†Ô∏è',
      label: 'Efficiency',
      value: end.dynamicallyEfficient ? 'Yes' : 'No',
      sub: `r ${end.dynamicallyEfficient ? '>' : '<'} n`,
      warn: !end.dynamicallyEfficient
    },
  ];

  document.getElementById('stats-grid').innerHTML = stats.map(s => `
    <div class="stat-card${s.warn ? ' warn' : ''}">
      <div class="stat-header">
        <span class="stat-icon">${s.icon}</span>
        <span class="stat-label">${s.label}</span>
      </div>
      <div class="stat-value">${s.value}</div>
      <div class="stat-sub">${s.sub}</div>
    </div>
  `).join('');
}

function renderParamTabs() {
  const tabs = ['production', 'preferences', 'demographics', 'government'];
  document.getElementById('param-tabs').innerHTML = tabs.map(t =>
    `<button class="tab-btn${activeParamTab === t ? ' active' : ''}" onclick="setParamTab('${t}')">${t.charAt(0).toUpperCase() + t.slice(1)}</button>`
  ).join('');
}

function renderParamContent() {
  const container = document.getElementById('param-content');

  if (activeParamTab === 'production') {
    container.innerHTML = `
      <div class="section-title">Cobb-Douglas Production</div>
      ${slider('alpha', 'Capital Share (Œ±)', 0.2, 0.5, 0.01, v => v.toFixed(2), 'Y = A¬∑K^Œ±¬∑L^(1-Œ±)')}
      ${slider('tfp', 'TFP Level (A)', 0.5, 2.0, 0.1, v => v.toFixed(1), 'Total factor productivity')}
      ${slider('tfpGrowth', 'TFP Growth', 0.0, 0.03, 0.005, v => (v*100).toFixed(1) + '%/yr', 'Technological progress')}
      ${slider('delta', 'Depreciation (Œ¥)', 0.02, 0.10, 0.01, v => (v*100).toFixed(0) + '%', 'Capital depreciation rate')}

      <div class="section-title">Initial Capital</div>
      ${slider('initialCapital', 'K/L Ratio', 1.0, 6.0, 0.5, v => v.toFixed(1), 'Starting capital intensity')}
    `;
  } else if (activeParamTab === 'preferences') {
    container.innerHTML = `
      <div class="section-title">CRRA Utility</div>
      <div style="padding:8px;background:rgba(55,65,81,0.5);border-radius:4px;margin-bottom:12px;">
        <div style="font-size:0.7rem;color:#9CA3AF;">
          <span style="color:#D1D5DB;font-family:serif;font-style:italic;">u(c) = c<sup>1-Œ≥</sup>/(1-Œ≥)</span><br>
          Euler: <span style="color:#D1D5DB;font-family:serif;font-style:italic;">c<sub>t+1</sub>/c<sub>t</sub> = (Œ≤(1+r))<sup>1/Œ≥</sup></span>
        </div>
      </div>
      ${slider('beta', 'Discount Factor (Œ≤)', 0.90, 0.99, 0.01, v => v.toFixed(2), 'Patience (Œ≤=0.96 ‚âà 4% discount)')}
      ${slider('gamma', 'Risk Aversion (Œ≥)', 0.5, 4.0, 0.5, v => v.toFixed(1), 'Œ≥=1 is log utility')}

      <div style="margin-top:12px;padding:8px;background:rgba(55,65,81,0.5);border-radius:4px;font-size:0.7rem;color:#9CA3AF;">
        <div style="font-weight:500;color:#D1D5DB;margin-bottom:4px;">Interpretation</div>
        <div>Higher Œ≤ ‚Üí more savings (patient)</div>
        <div>Higher Œ≥ ‚Üí smoother consumption</div>
      </div>
    `;
  } else if (activeParamTab === 'demographics') {
    container.innerHTML = `
      <div class="section-title">Population Dynamics</div>
      ${slider('birthRate', 'Birth Rate', 0.0, 0.03, 0.002, v => (v*100).toFixed(1) + '%', 'Annual births / working pop')}
      ${slider('agingRate', 'Aging Rate', 0.03, 0.08, 0.005, v => (v*100).toFixed(1) + '%', '1/years per life stage')}
      ${slider('deathRate', 'Death Rate (Old)', 0.03, 0.10, 0.01, v => (v*100).toFixed(0) + '%', 'Old-age mortality')}

      <div class="section-title">Demographic Shock</div>
      ${slider('agingShock', 'Aging Acceleration', 0.0, 0.03, 0.005, v => '+' + (v*100).toFixed(1) + '%', 'Extra aging (demographic transition)')}

      <div class="section-title">Initial Population</div>
      ${slider('initialPopYoung', 'Young (20-40)', 0.5, 1.5, 0.1, v => v.toFixed(1))}
      ${slider('initialPopMiddle', 'Middle (40-60)', 0.5, 1.5, 0.1, v => v.toFixed(1))}
      ${slider('initialPopOld', 'Old (60-80)', 0.3, 1.0, 0.1, v => v.toFixed(1))}
    `;
  } else if (activeParamTab === 'government') {
    container.innerHTML = `
      <div class="section-title">Fiscal Policy</div>
      ${slider('taxRate', 'Labor Tax Rate', 0.10, 0.40, 0.02, v => (v*100).toFixed(0) + '%', 'Tax on wage income')}
      ${slider('govSpendingRate', 'Gov Spending/GDP', 0.10, 0.30, 0.02, v => (v*100).toFixed(0) + '%', 'Government consumption')}
      ${slider('ssReplacementRate', 'SS Replacement', 0.20, 0.50, 0.05, v => (v*100).toFixed(0) + '%', 'Social Security / avg wage')}

      <div class="section-title">Government Debt</div>
      ${slider('initialDebtRatio', 'Initial Debt/GDP', 0.0, 2.0, 0.1, v => (v*100).toFixed(0) + '%', 'Starting debt ratio')}

      <div style="margin-top:12px;padding:8px;background:rgba(55,65,81,0.5);border-radius:4px;font-size:0.7rem;color:#9CA3AF;">
        <div style="font-weight:500;color:#D1D5DB;margin-bottom:4px;">Crowding Out</div>
        <div>Deficit = G + SS + rD - T</div>
        <div>Investment = Savings - Deficit</div>
        <div>Higher debt ‚Üí less capital accumulation</div>
      </div>

      <div class="section-title">Simulation</div>
      ${slider('yearsToSimulate', 'Years', 20, 100, 10, v => v + ' yrs')}
    `;
  }
}

function slider(key, label, min, max, step, format, hint) {
  return `
    <div class="slider-group">
      <div class="slider-header">
        <span class="slider-label">${label}</span>
        <span class="slider-value">${format(params[key])}</span>
      </div>
      <input type="range" min="${min}" max="${max}" step="${step}" value="${params[key]}"
             oninput="updateParam('${key}', parseFloat(this.value))">
      ${hint ? `<div class="slider-hint">${hint}</div>` : ''}
    </div>
  `;
}

function renderChartTabs() {
  const tabs = [
    { id: 'capital', label: 'Capital' },
    { id: 'prices', label: 'Prices' },
    { id: 'consumption', label: 'Consumption' },
    { id: 'demographics', label: 'Demographics' },
    { id: 'wealth', label: 'Wealth' },
    { id: 'fiscal', label: 'Fiscal' }
  ];
  document.getElementById('chart-tabs').innerHTML = tabs.map(t =>
    `<button class="tab-btn${activeChartTab === t.id ? ' active' : ''}" onclick="setChartTab('${t.id}')">${t.label}</button>`
  ).join('');
}

function renderChart() {
  const ctx = document.getElementById('mainChart').getContext('2d');
  if (chart) chart.destroy();

  const labels = simulationData.map(d => d.year);
  let datasets = [];
  let yConfig = {};

  if (activeChartTab === 'capital') {
    datasets = [
      { label: 'Capital (K)', data: simulationData.map(d => d.capital), borderColor: '#F59E0B', backgroundColor: 'rgba(245,158,11,0.2)', fill: true, tension: 0.3, yAxisID: 'y' },
      { label: 'Steady State (k*)', data: simulationData.map(d => d.kSteadyState), borderColor: '#10B981', borderDash: [5, 5], backgroundColor: 'transparent', tension: 0.3, yAxisID: 'y' },
      { label: 'Output (Y)', data: simulationData.map(d => d.output), borderColor: '#3B82F6', backgroundColor: 'transparent', tension: 0.3, yAxisID: 'y1' },
    ];
    yConfig = {
      y: { position: 'left', title: { display: true, text: 'Capital', color: '#9CA3AF' }, ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } },
      y1: { position: 'right', title: { display: true, text: 'Output', color: '#9CA3AF' }, ticks: { color: '#9CA3AF' }, grid: { display: false } }
    };
  } else if (activeChartTab === 'prices') {
    datasets = [
      { label: 'Interest Rate (r)', data: simulationData.map(d => d.interestRate * 100), borderColor: '#EF4444', backgroundColor: 'transparent', tension: 0.3 },
      { label: 'Gross MPK', data: simulationData.map(d => d.r_gross * 100), borderColor: '#F59E0B', borderDash: [3, 3], backgroundColor: 'transparent', tension: 0.3 },
      { label: 'Wage (w)', data: simulationData.map(d => d.wage * 10), borderColor: '#3B82F6', backgroundColor: 'transparent', tension: 0.3 },
    ];
    yConfig = { y: { title: { display: true, text: 'Rate (%) / Wage√ó10', color: '#9CA3AF' }, ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } } };
  } else if (activeChartTab === 'consumption') {
    datasets = [
      { label: 'Consumption', data: simulationData.map(d => d.consumption), borderColor: '#10B981', backgroundColor: 'rgba(16,185,129,0.2)', fill: true, tension: 0.3 },
      { label: 'Investment', data: simulationData.map(d => d.investment), borderColor: '#F59E0B', backgroundColor: 'transparent', tension: 0.3 },
      { label: 'Savings Rate', data: simulationData.map(d => d.savingsRate * 100), borderColor: '#8B5CF6', backgroundColor: 'transparent', tension: 0.3, yAxisID: 'y1' },
    ];
    yConfig = {
      y: { position: 'left', title: { display: true, text: 'Level', color: '#9CA3AF' }, ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } },
      y1: { position: 'right', title: { display: true, text: 'Rate (%)', color: '#9CA3AF' }, ticks: { color: '#9CA3AF', callback: v => v + '%' }, grid: { display: false } }
    };
  } else if (activeChartTab === 'demographics') {
    datasets = [
      { label: 'Young', data: simulationData.map(d => d.popYoung), borderColor: '#3B82F6', backgroundColor: 'rgba(59,130,246,0.2)', fill: true, tension: 0.3 },
      { label: 'Middle', data: simulationData.map(d => d.popMiddle), borderColor: '#10B981', backgroundColor: 'rgba(16,185,129,0.2)', fill: true, tension: 0.3 },
      { label: 'Old', data: simulationData.map(d => d.popOld), borderColor: '#F59E0B', backgroundColor: 'rgba(245,158,11,0.2)', fill: true, tension: 0.3 },
    ];
    yConfig = { y: { stacked: true, title: { display: true, text: 'Population', color: '#9CA3AF' }, ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } } };
  } else if (activeChartTab === 'wealth') {
    datasets = [
      { label: 'Young Wealth', data: simulationData.map(d => d.wealthYoung), borderColor: '#3B82F6', backgroundColor: 'transparent', tension: 0.3 },
      { label: 'Middle Wealth', data: simulationData.map(d => d.wealthMiddle), borderColor: '#10B981', backgroundColor: 'transparent', tension: 0.3 },
      { label: 'Old Wealth', data: simulationData.map(d => d.wealthOld), borderColor: '#F59E0B', backgroundColor: 'transparent', tension: 0.3 },
      { label: 'Total', data: simulationData.map(d => d.totalWealth), borderColor: '#8B5CF6', borderDash: [5, 5], backgroundColor: 'transparent', tension: 0.3 },
    ];
    yConfig = { y: { title: { display: true, text: 'Wealth', color: '#9CA3AF' }, ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } } };
  } else if (activeChartTab === 'fiscal') {
    datasets = [
      { label: 'Debt/GDP', data: simulationData.map(d => d.debtToGdp * 100), borderColor: '#EF4444', backgroundColor: 'rgba(239,68,68,0.2)', fill: true, tension: 0.3 },
      { label: 'Tax Revenue', data: simulationData.map(d => d.taxRevenue * 20), borderColor: '#10B981', backgroundColor: 'transparent', tension: 0.3 },
      { label: 'SS Payments', data: simulationData.map(d => d.ssPayments * 20), borderColor: '#F59E0B', backgroundColor: 'transparent', tension: 0.3 },
    ];
    yConfig = { y: { title: { display: true, text: 'Debt/GDP (%) / Flows√ó20', color: '#9CA3AF' }, ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } } };
  }

  chart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: '#9CA3AF', font: { size: 10 } } },
        tooltip: { backgroundColor: '#1F2937', borderColor: '#374151', borderWidth: 1 }
      },
      scales: {
        x: { ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } },
        ...yConfig
      }
    }
  });
}

function renderChartFooter() {
  const end = simulationData[simulationData.length - 1];
  document.getElementById('chart-footer').innerHTML = `
    <div class="footer-stat"><span>K/Y:</span> <span class="val amber">${(end.capital / end.output).toFixed(2)}</span></div>
    <div class="footer-stat"><span>C/Y:</span> <span class="val emerald">${(end.consumption / end.output).toFixed(2)}</span></div>
    <div class="footer-stat"><span>Debt/Y:</span> <span class="val red">${(end.debtToGdp * 100).toFixed(0)}%</span></div>
    <div class="footer-stat"><span>TFP:</span> <span class="val blue">${end.tfp.toFixed(2)}</span></div>
  `;
}

// ============================================
// EVENT HANDLERS
// ============================================
function setParamTab(tab) {
  activeParamTab = tab;
  renderParamTabs();
  renderParamContent();
}

function setChartTab(tab) {
  activeChartTab = tab;
  renderChartTabs();
  renderChart();
}

function updateParam(key, value) {
  params[key] = value;
  update();
}

function resetToDefaults() {
  params = { ...DEFAULT_PARAMS };
  update();
  renderParamContent();
}

function update() {
  simulationData = runSimulation();
  renderStats();
  renderChart();
  renderChartFooter();
  renderParamContent();
}

// ============================================
// INIT
// ============================================
function init() {
  simulationData = runSimulation();
  renderStats();
  renderParamTabs();
  renderParamContent();
  renderChartTabs();
  renderChart();
  renderChartFooter();
}

init();
</script>
</body>
</html>
